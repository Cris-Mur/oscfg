#!/bin/bash

# ====================================================
# FUNCIONES DE UTILIDAD
# ====================================================
draw_menu() {
    local -n opts=$1   # Array de opciones (referencia)
    local sel=$2       # Ãndice seleccionado
    local title=$3     # TÃ­tulo del menÃº

    clear
    tput setaf 4; tput bold
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    printf "â•‘   ğŸš€ %-30s ğŸš€   â•‘\n" "$title"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    tput sgr0
    echo

    for i in "${!opts[@]}"; do
        if [[ $i == $sel ]]; then
            tput setaf 2; tput bold
            printf " â–º %s\n" "${opts[$i]}"
            tput sgr0
        else
            printf "   %s\n" "${opts[$i]}"
        fi
    done

    echo
    tput setaf 3
    echo "[Usa â†‘ â†“ | Enter para elegir | q o ESC para salir/volver]"
    tput sgr0
}

read_key() {
    IFS= read -rsn1 input
    if [[ $input == $'\x1b' ]]; then
        read -rsn2 -t 0.001 rest
        input+=$rest
    fi
    echo "$input"
}

# ====================================================
# ACCIONES
# ====================================================
main_action() {
    case $1 in
        0) echo "ğŸ”µ Iniciando servicio..."; sleep 1 ;;
        1) echo "ğŸ”´ Deteniendo servicio..."; sleep 1 ;;
        2) echo "ğŸŸ¡ Reiniciando servicio..."; sleep 1 ;;
        3) submenu_status ;;  # Entrar al submenÃº
        4) echo "ğŸ‘‹ Saliendo..."; exit 0 ;;
    esac
}

submenu_action() {
    case $1 in
        0) echo "ğŸ“Š Estado detallado del servicio..."; sleep 1 ;;
        1) echo "ğŸ“„ Mostrando logs recientes..."; sleep 1 ;;
        2) return 1 ;;  # Volver al menÃº principal
    esac
    return 0
}

# ====================================================
# MENÃš PRINCIPAL
# ====================================================
main_menu() {
    local options=("Iniciar servicio" "Detener servicio" "Reiniciar servicio" "Ver estado" "Salir")
    local selected=0

    while true; do
        draw_menu options $selected "MENÃš PRINCIPAL"
        input=$(read_key)

        case $input in
            $'\x1b[A') ((selected--));;  # Flecha arriba
            $'\x1b[B') ((selected++));;  # Flecha abajo
            "") main_action $selected ;;
            q|Q|$'\x1b') echo "ğŸ‘‹ Saliendo..."; exit 0 ;;
        esac

        ((selected < 0)) && selected=0
        ((selected >= ${#options[@]})) && selected=$((${#options[@]} - 1))
    done
}

# ====================================================
# SUBMENÃš DE ESTADO
# ====================================================
submenu_status() {
    local options=("Ver estado detallado" "Ver logs" "Volver")
    local selected=0

    while true; do
        draw_menu options $selected "SUBMENÃš: ESTADO"
        input=$(read_key)

        case $input in
            $'\x1b[A') ((selected--));;
            $'\x1b[B') ((selected++));;
            "") submenu_action $selected || return ;;
            q|Q|$'\x1b') return ;;
        esac

        ((selected < 0)) && selected=0
        ((selected >= ${#options[@]})) && selected=$((${#options[@]} - 1))
    done
}

# ====================================================
# INICIO DEL PROGRAMA
# ====================================================
main_menu

